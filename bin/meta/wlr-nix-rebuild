#!/usr/bin/env bash
set -euo pipefail

if ! command -v nix >/dev/null 2>&1; then
    wlr-err "Nix not installed"
    exit 1
fi

# Determine which flake to use - prefer private overlay if it exists
PRIVATE_ENV_PATH="$HOME/.wlrenv-private"
if [[ -d "$PRIVATE_ENV_PATH" ]]; then
    FLAKE_PATH="$PRIVATE_ENV_PATH"
else
    FLAKE_PATH="$WLR_ENV_PATH"
fi

cd "$FLAKE_PATH"

export NIX_CONFIG="experimental-features = nix-command flakes"
home_manager=(
    nix
    run
    home-manager/release-25.11
    --
)

# Get short hostname with fallback chain
get_short_hostname() {
    local hn
    # Try hostname -s first (most traditional)
    if command -v hostname >/dev/null 2>&1; then
        hn=$(hostname -s 2>/dev/null) && [ -n "$hn" ] && echo "$hn" && return 0
    fi
    # Fall back to uname -n (POSIX-compliant, very portable)
    if hn=$(uname -n 2>/dev/null) && [ -n "$hn" ]; then
        # Strip domain if present to get short hostname
        echo "${hn%%.*}"
        return 0
    fi
    # Fall back to /proc/sys/kernel/hostname on Linux
    if [ -f /proc/sys/kernel/hostname ]; then
        hn=$(cat /proc/sys/kernel/hostname 2>/dev/null) && [ -n "$hn" ] && echo "${hn%%.*}" && return 0
    fi
    return 1
}

# Check if a config exists in the flake
config_exists() {
    local config="$1"
    nix eval --json ".#homeConfigurations" --apply 'x: builtins.attrNames x' 2>/dev/null | grep -q "\"${config}\""
}

# Determine which config to use (user@hostname if exists, otherwise just user)
NIX_PROFILE="${USER}"
if SHORT_HOSTNAME=$(get_short_hostname); then
    HOST_PROFILE="${USER}@${SHORT_HOSTNAME}"
    if config_exists "${HOST_PROFILE}"; then
        NIX_PROFILE="${HOST_PROFILE}"
    else
        wlr-warn "Config for ${HOST_PROFILE} not found, falling back to ${USER}"
    fi
fi

"${home_manager[@]}" switch --flake "${FLAKE_PATH}#${NIX_PROFILE}"

# On macOS, also run darwin-rebuild for system-level config (Homebrew casks, etc.)
if [ "$(uname -s)" = "Darwin" ]; then
    nix_darwin=(
        nix
        run
        nix-darwin
        --
    )
    # Replace dots with underscores for darwin config name (nix-darwin doesn't handle dots well)
    DARWIN_PROFILE="${NIX_PROFILE//./_}"

    # Build first (no sudo needed) to check if anything changed
    "${nix_darwin[@]}" build --flake "${FLAKE_PATH}#${DARWIN_PROFILE}"

    # Compare new build to current system - only activate if different
    NEW_SYSTEM="$(readlink ./result)"
    CURRENT_SYSTEM="$(readlink /run/current-system 2>/dev/null || echo "")"

    if [ "${NEW_SYSTEM}" != "${CURRENT_SYSTEM}" ]; then
        sudo "${nix_darwin[@]}" switch --flake "${FLAKE_PATH}#${DARWIN_PROFILE}"
    else
        echo "nix-darwin: no changes to activate"
    fi

    # Clean up result symlink
    rm -f ./result
fi
