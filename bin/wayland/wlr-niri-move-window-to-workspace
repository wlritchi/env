#!/usr/bin/env bash
set -euo pipefail

# Wait for a window with a specific PID to appear in niri,
# then move it to the specified workspace

if [ $# -ne 2 ]; then
    echo "Usage: $0 <pid> <workspace_index>" >&2
    exit 1
fi

pid="$1"
target_workspace="$2"
timeout=5

if ! command -v niri >/dev/null 2>&1; then
    echo "niri not found" >&2
    exit 1
fi

if ! command -v jq >/dev/null 2>&1; then
    echo "jq not found" >&2
    exit 1
fi

if [ -z "${NIRI_SOCKET:-}" ]; then
    echo "NIRI_SOCKET not set" >&2
    exit 1
fi

# Wait for window with this PID to appear
start_time=$(date +%s)
window_id=""

while true; do
    if [ $(($(date +%s) - start_time)) -gt $timeout ]; then
        echo "Timeout waiting for window with PID $pid" >&2
        exit 1
    fi

    # Query for window with matching PID
    window_id=$(niri msg --json windows | jq -r ".[] | select(.pid == $pid) | .id" | head -1)

    if [ -n "$window_id" ]; then
        break
    fi

    sleep 0.1
done

# Move window to target workspace
niri msg action move-window-to-workspace --window-id "$window_id" --focus false "$target_workspace"
