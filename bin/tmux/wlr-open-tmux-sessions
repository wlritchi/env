#!/bin/bash
set -euo pipefail

term="${TERMINAL:-alacritty}"
readarray -t detached_sessions < <( tmux list-sessions -F '#{session_name}' -f '#{?#{session_attached},0,1}' )

if ! command -v "$term" >/dev/null 2>&1; then
    echo "Terminal not found: $term" >&2
    exit 1
fi

# Helper function to spawn session and configure window
spawn_and_configure() {
    local session="$1"
    local workspace="$2"
    local width="$3"

    # Spawn terminal
    "$term" -e tmux attach-session -t "$session" &
    local alacritty_pid=$!

    # Build arguments for configure script
    local args=()
    if [ -n "$workspace" ]; then
        args+=(--workspace "$workspace")
    fi
    if [ -n "$width" ]; then
        args+=(--width "$width")
    fi

    # Configure window if we have any options to set
    if [ ${#args[@]} -gt 0 ]; then
        if command -v wlr-niri-configure-window >/dev/null 2>&1; then
            wlr-niri-configure-window "$alacritty_pid" "${args[@]}" 2>/dev/null || true
        fi
    fi
}

for session in "${detached_sessions[@]}"; do
    # Skip temporary sessions (git commit hashes)
    if ! echo "$session" | grep -Eq '^[0-9a-f]{7}$'; then
        # Get saved workspace and width
        workspace=$(tmux show-options -t "$session" -v @niri-workspace 2>/dev/null || true)
        width=$(tmux show-options -t "$session" -v @niri-width 2>/dev/null || true)
        spawn_and_configure "$session" "$workspace" "$width"
    fi
done
