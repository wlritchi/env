#!/usr/bin/env bash
set -euo pipefail

# Track which niri workspace each tmux session is on
# This script queries niri for Alacritty windows, finds their tmux sessions,
# and stores the workspace mapping in tmux user options

if ! command -v niri >/dev/null 2>&1; then
    echo "niri not found" >&2
    exit 1
fi

if ! command -v jq >/dev/null 2>&1; then
    echo "jq not found" >&2
    exit 1
fi

if [ -z "${NIRI_SOCKET:-}" ]; then
    echo "NIRI_SOCKET not set" >&2
    exit 1
fi

# Build output width map: output_name -> logical_width
declare -A output_widths
while IFS=$'\t' read -r output_name width; do
    output_widths["$output_name"]="$width"
done < <(niri msg --json outputs | jq -r '.[] | "\(.name)\t\(.logical.width)"')

# Build workspace to output map: workspace_id -> output_name
declare -A workspace_outputs
while IFS=$'\t' read -r ws_id output_name; do
    workspace_outputs["$ws_id"]="$output_name"
done < <(niri msg --json workspaces | jq -r '.[] | "\(.id)\t\(.output)"')

# Get all Alacritty windows with their PIDs, workspace IDs, and tile widths
while IFS=$'\t' read -r alacritty_pid workspace_id tile_width; do
    # Find child processes of this alacritty
    children=$(pgrep -P "$alacritty_pid" 2>/dev/null || true)

    for child_pid in $children; do
        # Check if this child is a tmux client
        comm=$(ps -o comm= -p "$child_pid" 2>/dev/null || true)

        if [ "$comm" = "tmux" ] || [ "$comm" = "tmux: client" ]; then
            # Get the full command line to extract session name
            args=$(ps -o args= -p "$child_pid" 2>/dev/null || true)

            # Parse session name from: tmux attach-session -t <session>
            if [[ "$args" =~ -t[[:space:]]+([^[:space:]]+) ]]; then
                session="${BASH_REMATCH[1]}"

                # Set the workspace and width options for this session
                if tmux has-session -t "$session" 2>/dev/null; then
                    tmux set-option -t "$session" @niri-workspace "$workspace_id" 2>/dev/null || true

                    # Calculate width percentage
                    output_name="${workspace_outputs[$workspace_id]:-}"
                    if [ -n "$output_name" ]; then
                        monitor_width="${output_widths[$output_name]:-}"
                        if [ -n "$monitor_width" ] && [ "$monitor_width" -gt 0 ]; then
                            # Calculate percentage and round to nearest 10%
                            width_percent=$(awk -v tw="$tile_width" -v mw="$monitor_width" 'BEGIN { printf "%.0f", int((tw / mw * 100 + 5) / 10) * 10 }')
                            tmux set-option -t "$session" @niri-width "$width_percent" 2>/dev/null || true
                        fi
                    fi
                fi
            fi
        fi
    done
done < <(niri msg --json windows | jq -r '.[] | select(.app_id == "Alacritty") | "\(.pid)\t\(.workspace_id)\t\(.layout.tile_size[0])"')
