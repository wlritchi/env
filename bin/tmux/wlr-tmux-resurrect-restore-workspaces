#!/usr/bin/env bash
set -euo pipefail

# tmux-resurrect pre-restore-pane-processes hook
# Restores niri workspace mappings from the resurrect save file
# This runs AFTER sessions are created but BEFORE processes are started

# Find the resurrect save file
save_file="$HOME/.local/share/tmux/resurrect/last"
if [ ! -f "$save_file" ]; then
    save_file="$HOME/.tmux/resurrect/last"
fi

if [ ! -f "$save_file" ]; then
    # No save file, nothing to restore
    exit 0
fi

# Read workspace data and restore to session options
grep "^niri_workspace" "$save_file" 2>/dev/null | \
while IFS=$'\t' read -r _ session workspace; do
    # Sessions should exist now, but still fail gracefully
    tmux set-option -t "$session" @niri-workspace "$workspace" 2>/dev/null || true
done
