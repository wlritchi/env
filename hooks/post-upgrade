#!/bin/bash
set -euo pipefail

# sync dotfiles
"$WLR_ENV_PATH/bin/meta/wlr-sync-dotfiles"

# check gitconfig setup
if [ ! -f ~/.gitconfig ]; then
    cp "$WLR_ENV_PATH/config/git/local.template" ~/.gitconfig
    wlr-warn "Created ~/.gitconfig from template - edit HOSTNAME and user.signingKey"
elif ! grep -q 'path.*\.wlrenv/config/git/common' ~/.gitconfig; then
    wlr-warn "~/.gitconfig missing include for common gitconfig - see config/git/local.template"
fi

# set up git config for env
git -C "$WLR_ENV_PATH" config --local gpg.ssh.allowedSignersFile "$WLR_ENV_PATH/.allowed_signers"

if command -v tmux >/dev/null 2>&1; then
    if ! [ -e "$HOME/.tmux/plugins/tpm" ]; then
        mkdir -p ~/.tmux/plugins/
        git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
    fi

    # reload tmux config
    tmux source-file "$HOME/.tmux.conf" && \
    "$HOME/.tmux/plugins/tpm/bin/install_plugins" || echo "Failed to connect to tmux"
fi

# Rebuild Nix environment (includes niri-spacer and other Rust utilities)
"$WLR_ENV_PATH/bin/meta/wlr-nix-rebuild"
